{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 animate-fade-in">
    
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-2">
                    <i class="fas fa-chart-line text-purple-500 mr-3"></i>Admin Dashboard
                </h1>
                <p class="text-slate-600 dark:text-slate-400">
                    Comprehensive overview of FlixReview platform statistics
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="location.reload()" 
                        class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <a href="{% url 'admin:index' %}" 
                   class="px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-cog mr-2"></i>Admin Panel
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Users Card -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 hover-lift border-l-4 border-purple-500">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-xl">
                    <i class="fas fa-users text-purple-500 text-2xl"></i>
                </div>
                <span class="text-xs font-semibold text-green-500 bg-green-100 dark:bg-green-900 px-3 py-1 rounded-full">
                    +{{ stats.users.new_7d }} this week
                </span>
            </div>
            <h3 class="text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wide mb-2">Total Users</h3>
            <p class="text-4xl font-bold text-slate-900 dark:text-white mb-4">{{ stats.users.total|default:"0" }}</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                    <span class="text-slate-600 dark:text-slate-400 block text-xs">Active</span>
                    <span class="text-slate-900 dark:text-white font-semibold">{{ stats.users.active|default:"0" }}</span>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                    <span class="text-slate-600 dark:text-slate-400 block text-xs">Staff</span>
                    <span class="text-slate-900 dark:text-white font-semibold">{{ stats.users.staff|default:"0" }}</span>
                </div>
            </div>
        </div>

        <!-- Movies Card -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 hover-lift border-l-4 border-cyan-500">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-cyan-100 dark:bg-cyan-900 p-3 rounded-xl">
                    <i class="fas fa-film text-cyan-500 text-2xl"></i>
                </div>
                <span class="text-xs font-semibold text-cyan-500 bg-cyan-100 dark:bg-cyan-900 px-3 py-1 rounded-full">
                    <i class="fas fa-star"></i> {{ stats.movies.avg_rating|default:"0"|floatformat:1 }}
                </span>
            </div>
            <h3 class="text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wide mb-2">Total Movies</h3>
            <p class="text-4xl font-bold text-slate-900 dark:text-white mb-4">{{ stats.movies.total|default:"0" }}</p>
            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                <span class="text-slate-600 dark:text-slate-400 block text-xs">With Reviews</span>
                <span class="text-slate-900 dark:text-white font-semibold">{{ stats.movies.with_reviews|default:"0" }}</span>
            </div>
        </div>

        <!-- Reviews Card -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 hover-lift border-l-4 border-amber-500">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-amber-100 dark:bg-amber-900 p-3 rounded-xl">
                    <i class="fas fa-star text-amber-500 text-2xl"></i>
                </div>
                <span class="text-xs font-semibold text-green-500 bg-green-100 dark:bg-green-900 px-3 py-1 rounded-full">
                    +{{ stats.reviews.last_7d|default:"0" }} this week
                </span>
            </div>
            <h3 class="text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wide mb-2">Total Reviews</h3>
            <p class="text-4xl font-bold text-slate-900 dark:text-white mb-4">{{ stats.reviews.total|default:"0" }}</p>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                    <span class="text-slate-600 dark:text-slate-400 block text-xs">Last 30d</span>
                    <span class="text-slate-900 dark:text-white font-semibold">{{ stats.reviews.last_30d|default:"0" }}</span>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                    <span class="text-slate-600 dark:text-slate-400 block text-xs">Avg Rating</span>
                    <span class="text-slate-900 dark:text-white font-semibold">{{ stats.reviews.avg_rating|default:"0"|floatformat:1 }}</span>
                </div>
            </div>
        </div>

        <!-- Genres Card -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 hover-lift border-l-4 border-pink-500">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-pink-100 dark:bg-pink-900 p-3 rounded-xl">
                    <i class="fas fa-tags text-pink-500 text-2xl"></i>
                </div>
                <span class="text-xs font-semibold text-pink-500 bg-pink-100 dark:bg-pink-900 px-3 py-1 rounded-full">
                    Catalog
                </span>
            </div>
            <h3 class="text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wide mb-2">Total Genres</h3>
            <p class="text-4xl font-bold text-slate-900 dark:text-white mb-4">{{ stats.genres.total|default:"0" }}</p>
            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg px-3 py-2">
                <span class="text-slate-600 dark:text-slate-400 block text-xs">With Movies</span>
                <span class="text-slate-900 dark:text-white font-semibold">{{ stats.genres.with_movies|default:"0" }}</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Rating Distribution Chart -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-chart-bar text-purple-500 mr-3"></i>Rating Distribution
            </h3>
            <canvas id="ratingChart" class="max-h-80"></canvas>
        </div>

        <!-- Activity Trend Chart -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-chart-line text-cyan-500 mr-3"></i>Activity Trend
            </h3>
            <canvas id="activityChart" class="max-h-80"></canvas>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Recent Users -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center">
                    <i class="fas fa-user-plus text-purple-500 mr-3"></i>Recent Users
                </h3>
                <a href="{% url 'admin:accounts_user_changelist' %}" 
                   class="text-purple-500 hover:text-purple-600 text-sm font-semibold">
                    View All →
                </a>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for user in recent_activity.users %}
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-white font-bold">
                            {{ user.email|slice:":1"|upper }}
                        </div>
                        <div>
                            <p class="font-semibold text-slate-900 dark:text-white text-sm">{{ user.email|truncatechars:20 }}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                <i class="far fa-clock mr-1"></i>{{ user.date_joined|timesince }} ago
                            </p>
                        </div>
                    </div>
                    <span class="text-xs text-green-500 bg-green-100 dark:bg-green-900 px-2 py-1 rounded-full">New</span>
                </div>
                {% empty %}
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm">No recent users</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Reviews -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center">
                    <i class="fas fa-comment-dots text-amber-500 mr-3"></i>Recent Reviews
                </h3>
                <a href="{% url 'admin:reviews_review_changelist' %}" 
                   class="text-amber-500 hover:text-amber-600 text-sm font-semibold">
                    View All →
                </a>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for review in recent_activity.reviews %}
                <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors duration-200">
                    <div class="flex items-start justify-between mb-2">
                        <p class="font-semibold text-slate-900 dark:text-white text-sm">{{ review.user.email|truncatechars:20 }}</p>
                        <div class="flex items-center space-x-1">
                            {% for i in "12345"|make_list %}
                                <i class="fas fa-star text-xs {% if forloop.counter <= review.rating %}text-amber-400{% else %}text-slate-300 dark:text-slate-600{% endif %}"></i>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-2">
                        <i class="fas fa-film mr-1"></i>{{ review.movie.title|truncatechars:25 }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                        <i class="far fa-clock mr-1"></i>{{ review.created_at|timesince }} ago
                    </p>
                </div>
                {% empty %}
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm">No recent reviews</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Rated Movies -->
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-3"></i>Top Rated
                </h3>
                <a href="{% url 'admin:movies_movie_changelist' %}" 
                   class="text-yellow-500 hover:text-yellow-600 text-sm font-semibold">
                    View All →
                </a>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                {% for movie in top_movies %}
                <div class="p-3 bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-slate-700 dark:to-slate-700 rounded-xl hover:shadow-md transition-all duration-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="font-semibold text-slate-900 dark:text-white text-sm">{{ movie.title|truncatechars:25 }}</p>
                        <span class="text-xs font-bold text-yellow-600 dark:text-yellow-400 bg-yellow-100 dark:bg-yellow-900 px-2 py-1 rounded-full">
                            <i class="fas fa-star"></i> {{ movie.avg_rating|floatformat:1 }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400">
                        <span><i class="far fa-comment-dots mr-1"></i>{{ movie.reviews.count }} reviews</span>
                        <span class="text-slate-500 dark:text-slate-500">{{ movie.release_date|date:"Y" }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm">No rated movies yet</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
    // Rating Distribution Chart
    const ratingCtx = document.getElementById('ratingChart');
    if (ratingCtx) {
        // Sample data - replace with dynamic data from backend context
        const ratingData = [12, 25, 45, 78, 95];
        
        new Chart(ratingCtx, {
            type: 'bar',
            data: {
                labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                datasets: [{
                    label: 'Number of Reviews',
                    data: ratingData,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(251, 146, 60, 0.7)',
                        'rgba(251, 191, 36, 0.7)',
                        'rgba(34, 197, 94, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                    ],
                    borderColor: [
                        'rgb(239, 68, 68)',
                        'rgb(251, 146, 60)',
                        'rgb(251, 191, 36)',
                        'rgb(34, 197, 94)',
                        'rgb(16, 185, 129)',
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: { size: 12 }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 12 }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Activity Trend Chart
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx) {
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Reviews',
                    data: [12, 19, 15, 25, 22, 30, 28],
                    borderColor: 'rgb(139, 92, 246)',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                }, {
                    label: 'New Users',
                    data: [5, 8, 6, 10, 8, 12, 11],
                    borderColor: 'rgb(6, 182, 212)',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: '600' },
                            padding: 15,
                            usePointStyle: true,
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: { size: 12 }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 12 }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}